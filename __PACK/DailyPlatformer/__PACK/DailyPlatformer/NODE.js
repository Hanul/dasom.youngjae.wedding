DailyPlatformer.CostumeModel=OBJECT({preset:()=>{return DailyPlatformer.MODEL},params:()=>{let e={userId:{notEmpty:!0,id:!0},type:{notEmpty:!0,size:{min:1,max:20}}};return{name:"Costume",initData:{},methodConfig:{create:{valid:VALID(e)}}}}}),DailyPlatformer.UserModel=OBJECT({preset:()=>{return DailyPlatformer.MODEL},params:()=>{let e={nickname:{notEmpty:!0,size:{min:1,max:20}},gold:{notEmpty:!0,integer:!0},costumeType:{notEmpty:!0,size:{min:1,max:20}}};return{name:"User",initData:{gold:0,costumeType:"Costume1"},methodConfig:{create:{valid:VALID(e)}}}}});DailyPlatformer.GameRoom=OBJECT({init:(e,t)=>{let o=DailyPlatformer.SHARED_STORE("stageStore"),a=DailyPlatformer.SHARED_STORE("userInfoStore");DailyPlatformer.SHARED_STORE("recordStore");DISTRIBUTE_PROCESS({tag:"stageInfo"},()=>{let e=[];REPEAT(4,()=>{e.push(RANDOM(12))}),o.save({id:"stageInfo",data:{sections:e}})}),DailyPlatformer.ROOM("Game",(e,t,o,i,n)=>{let d;t("connect",(e,t)=>{void 0!==e&&(d=e,a.all(e=>{t(e)}))}),t("enter",(e,t)=>{void 0!==d&&DailyPlatformer.UserModel.get(d,e=>{n({roomName:"Game",methodName:"enter",data:{userId:d,nickname:e.nickname,costumeType:e.costumeType,x:189,y:693}}),a.save({id:d,data:{userId:d,nickname:e.nickname,costumeType:e.costumeType,x:189,y:693}})})}),t("changeSkin",(e,t)=>{void 0!==d&&void 0!==e&&(n({roomName:"Game",methodName:"changeSkin",data:{userId:d,costumeType:e}}),a.update({id:d,data:{costumeType:e}},{notExists:()=>{}}))}),t("moveLeft",(e,t)=>{void 0!==d&&(n({roomName:"Game",methodName:"moveLeft",data:d}),a.update({id:d,data:{direction:"left",moveStartTime:new Date}}))}),t("moveRight",(e,t)=>{void 0!==d&&(n({roomName:"Game",methodName:"moveRight",data:d}),a.update({id:d,data:{direction:"right",moveStartTime:new Date}}))}),t("stop",(e,t)=>{void 0!==d&&void 0!==e&&(n({roomName:"Game",methodName:"stop",data:{userId:d,x:e.x,y:e.y}}),a.update({id:d,data:{x:e.x,y:e.y,direction:TO_DELETE,moveStartTime:TO_DELETE}}))}),t("stopLeft",(e,t)=>{void 0!==d&&void 0!==e&&(n({roomName:"Game",methodName:"stopLeft",data:{userId:d,x:e.x,y:e.y}}),a.update({id:d,data:{x:e.x,y:e.y,direction:TO_DELETE,moveStartTime:TO_DELETE}}))}),t("stopRight",(e,t)=>{void 0!==d&&void 0!==e&&(n({roomName:"Game",methodName:"stopRight",data:{userId:d,x:e.x,y:e.y}}),a.update({id:d,data:{x:e.x,y:e.y,direction:TO_DELETE,moveStartTime:TO_DELETE}}))}),t("jump",(e,t)=>{void 0!==d&&n({roomName:"Game",methodName:"jump",data:d})}),t("stopJump",(e,t)=>{void 0!==d&&n({roomName:"Game",methodName:"stopJump",data:d})}),t("die",(e,t)=>{void 0!==d&&n({roomName:"Game",methodName:"die",data:d})}),t("win",(e,t)=>{void 0!==d&&void 0!==e&&n({roomName:"Game",methodName:"win",data:d})}),t("retry",(e,t)=>{void 0!==d&&(n({roomName:"Game",methodName:"retry",data:d}),a.update({id:d,data:{x:189,y:693}}))}),t("__DISCONNECTED",()=>{void 0!==d&&(n({roomName:"Game",methodName:"exit",data:d}),a.remove(d,{notExists:()=>{}}),d=void 0)})})}}),DailyPlatformer.MAIN=METHOD({run:(e,t)=>{let o=DailyPlatformer.SHARED_STORE("stageStore"),a=(DailyPlatformer.SHARED_STORE("userInfoStore"),DailyPlatformer.SHARED_STORE("recordStore"));e((e,t,i,n)=>{let d=e.uri,r=e.data,m=e=>{t({headers:{"Access-Control-Allow-Origin":"*"},content:e})};if("createUser"===d&&void 0!==r)return DailyPlatformer.UserModel.create({nickname:r.nickname},{notValid:e=>{m(STRINGIFY({validErrors:e}))},success:e=>{m(STRINGIFY({userData:e}))}}),!1;if("checkUserExists"===d&&void 0!==r)return DailyPlatformer.UserModel.checkExists({filter:{id:r}},e=>{m(STRINGIFY({exists:e}))}),!1;if("getStageInfo"===d&&void 0!==r)return o.get("stageInfo",e=>{a.get(r,{notExists:()=>{m(STRINGIFY({sections:e.sections,bestRecord:e.bestRecord}))},success:t=>{a.count({second:{$lt:t.second}},o=>{m(STRINGIFY({sections:e.sections,bestRecord:e.bestRecord,myRecord:t.second,myRank:o+1}))})}})}),!1;if("getUserData"===d&&void 0!==r)return DailyPlatformer.UserModel.get(r,e=>{DailyPlatformer.CostumeModel.find({filter:{userId:e.id}},t=>{m(STRINGIFY({userData:e,costumeDataSet:t}))})}),!1;if("win"===d&&void 0!==r){let e=r.userId,t=r.second;return DailyPlatformer.UserModel.update({id:e,$inc:{gold:10}}),NEXT([o=>{a.get(e,{notExists:()=>{a.save({id:e,data:{second:t}},o)},success:i=>{i.second>t?a.save({id:e,data:{second:t}},o):o(i)}})},()=>{return e=>{o.get("stageInfo",t=>{void 0===t.bestRecord||t.bestRecord>e.second?(o.update({id:"stageInfo",data:{bestRecord:e.second}}),m(STRINGIFY({bestRecord:e.second,myRecord:e.second,myRank:1}))):a.count({second:{$lt:e.second}},o=>{m(STRINGIFY({bestRecord:t.bestRecord,myRecord:e.second,myRank:o+1}))})})}}]),!1}if("buyCostume"===d&&void 0!==r){let e=r.userId,t=r.costumeType,o=r.gold;return DailyPlatformer.CostumeModel.create({userId:e,type:t},t=>{DailyPlatformer.UserModel.update({id:e,$inc:{gold:-o}}),m(STRINGIFY(t))}),!1}if("wearCostume"===d&&void 0!==r){let e=r.userId,t=r.costumeType;return DailyPlatformer.UserModel.update({id:e,costumeType:t}),!1}})}}),OVERRIDE(DailyPlatformer.UserModel,e=>{DailyPlatformer.UserModel=OBJECT({preset:()=>{return e},init:(e,t,o)=>{e.on("create",{after:(e,t)=>{return DailyPlatformer.CostumeModel.create({userId:e.id,type:"Costume1"},t),!1}})}})});